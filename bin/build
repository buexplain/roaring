#!/usr/bin/env php
<?php

$srcDir = __DIR__ . "/../src";

buildH($srcDir . "/CRoaring/src/library.c", $srcDir . "/CRoaring/shared/library.h");

$os = strtolower(PHP_OS_FAMILY);
$arch = getArchitecture();
$ext = $os === 'windows' ? 'dll' : 'so';
$library = "$srcDir/CRoaring/shared/library-$os-$arch.$ext";
if (PHP_OS_FAMILY === 'Windows') {
    shell_exec("gcc -O2 -g0 -s -fPIC -shared -o $library $srcDir/CRoaring/src/library.c");
} else if (PHP_OS_FAMILY === 'Linux') {
    shell_exec("gcc -O2 -g0 -s -fPIC -shared -o $library $srcDir/CRoaring/src/library.c");
} else if (PHP_OS_FAMILY === 'Darwin') {
    shell_exec("gcc -O2 -g0 -fPIC -shared -o $library $srcDir/CRoaring/src/library.c");
}

echo "ok\n";

function buildH(string $cFile, string $hFile): void
{
    $lines = file($cFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $flag = 0;
    $start = 0;
    $unsetLineNumber = [];
    foreach ($lines as $k => $line) {
        $line = rtrim($line);
        if (stripos($line, '#include') === 0) {
            $unsetLineNumber[] = $k;
            continue;
        }
        if ($line === '{' || (stripos($line, 'bp') !== false && stripos($line, '{') !== false)) {
            $flag += 1;
            if ($flag === 1) {
                if ($line === '{') {
                    $lines[$k - 1] .= ";";
                    $start = $k;
                } else {
                    $lines[$k] = rtrim($lines[$k], '{ ') . ';';
                    $start = $k + 1;
                }
            }
        } else if ($line === '}') {
            $flag -= 1;
            if ($flag === 0) {
                for ($i = $start; $i <= $k; $i++) {
                    $unsetLineNumber[] = $i;
                }
                $start = 0;
            }
        }
    }
    foreach ($unsetLineNumber as $lineNumber) {
        unset($lines[$lineNumber]);
    }
    array_unshift($lines, '#include "stdint.h"');
    file_put_contents($hFile, implode("\n", $lines));
}

function getArchitecture(): string
{
    $arch = strtolower(php_uname('m'));
    if (str_contains($arch, 'x86_64') || str_contains($arch, 'amd64')) {
        $arch = 'x86_64';
    } elseif (str_contains($arch, 'i386') || str_contains($arch, 'i686') || str_contains($arch, 'x86')) {
        $arch = 'x86';
    } elseif (str_contains($arch, 'arm64') || str_contains($arch, 'aarch64')) {
        $arch = 'arm64';
    } elseif (str_starts_with($arch, 'arm')) {
        $arch = 'arm';
    } else {
        $arch = 'unknown';
    }
    return $arch;
}