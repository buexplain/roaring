#!/usr/bin/env php
<?php

$srcDir = __DIR__ . "/../src";

buildH($srcDir . "/CRoaring/src/library.c", $srcDir . "/CRoaring/shared/library.h");

if (PHP_OS_FAMILY === 'Windows') {
    //gcc -O2 -g0 -s -fPIC -shared -o src/CRoaring/shared/library.dll src/CRoaring/src/library.c
    shell_exec("gcc -O2 -g0 -s -fPIC -shared -o $srcDir/CRoaring/shared/library.dll $srcDir/CRoaring/src/library.c");
} else if (PHP_OS_FAMILY === 'Linux') {
    //gcc -O2 -g0 -s -fPIC -shared -o /mnt/d/code/buexplain/roaring/src/CRoaring/shared/library.so /mnt/d/code/buexplain/roaring/src/CRoaring/src/library.c
    shell_exec("gcc -O2 -g0 -s -fPIC -shared -o $srcDir/CRoaring/shared/library.so $srcDir/CRoaring/src/library.c");
}

echo "ok\n";

function buildH(string $cFile, string $hFile): void
{
    $lines = file($cFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    $flag = 0;
    $start = 0;
    $unsetLineNumber = [];
    foreach ($lines as $k => $line) {
        $line = rtrim($line);
        if (stripos($line, '#include') === 0) {
            $unsetLineNumber[] = $k;
            continue;
        }
        if ($line === '{' || (stripos($line, 'bp') !== false && stripos($line, '{') !== false)) {
            $flag += 1;
            if ($flag === 1) {
                if ($line === '{') {
                    $lines[$k - 1] .= ";";
                    $start = $k;
                } else {
                    $lines[$k] = rtrim($lines[$k], '{ ') . ';';
                    $start = $k + 1;
                }
            }
        } else if ($line === '}') {
            $flag -= 1;
            if ($flag === 0) {
                for ($i = $start; $i <= $k; $i++) {
                    $unsetLineNumber[] = $i;
                }
                $start = 0;
            }
        }
    }
    foreach ($unsetLineNumber as $lineNumber) {
        unset($lines[$lineNumber]);
    }
    array_unshift($lines, '#include "stdint.h"');
    file_put_contents($hFile, implode("\n", $lines));
}
